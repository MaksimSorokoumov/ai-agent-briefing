# Система предотвращения дубликатов вопросов

## Проблема
При первичной и повторной генерации вопросов некоторые вопросы могли повторяться (иногда с небольшими вариациями) даже в рамках одной сессии.

## Решение
Реализована комплексная система предотвращения дубликатов вопросов:

### 1. Отслеживание истории вопросов
- Добавлено поле `all_asked_questions: List[str]` в модель `SessionData`
- Все заданные вопросы сохраняются в этом списке на протяжении всей сессии
- История сохраняется между итерациями

### 2. Алгоритм обнаружения дубликатов
- **Нормализация**: Приведение вопросов к единому формату (убираем знаки препинания, лишние пробелы, приводим к нижнему регистру)
- **Точное совпадение**: Проверка на полное совпадение нормализованных вопросов
- **Схожесть**: Использование `difflib.SequenceMatcher` для определения схожести (порог 70%)

### 3. Фильтрация дубликатов
- Метод `_filter_duplicate_questions()` исключает похожие вопросы из списка
- Логирование исключенных дубликатов для отладки

### 4. Генерация дополнительных вопросов
- Если после фильтрации остается недостаточно уникальных вопросов, система генерирует дополнительные
- Метод `_regenerate_unique_questions()` создает новые вопросы с учетом уже заданных

### 5. Интеграция с промптами
- В промпты для ИИ добавлен список уже заданных вопросов с инструкцией не повторять их
- Явные указания генерировать только уникальные вопросы

## Измененные файлы

### `models.py`
- Добавлено поле `all_asked_questions` в `SessionData`
- Обновлены методы сериализации/десериализации

### `question_generator.py`
- Добавлены методы:
  - `_is_similar_question()` - проверка схожести
  - `_normalize_question()` - нормализация текста
  - `_filter_duplicate_questions()` - фильтрация дубликатов
  - `_regenerate_unique_questions()` - генерация дополнительных вопросов
- Обновлены методы генерации для использования списка существующих вопросов

### `neural_network.py`
- Обновлены методы для передачи списка существующих вопросов
- Добавлена поддержка параметра `existing_questions`

### `gui_app.py`
- Добавлено сохранение новых вопросов в `all_asked_questions`
- Передача списка существующих вопросов при генерации

## Использование

### Для разработчиков
```python
# Генерация вопросов с учетом уже заданных
existing_questions = ["Это будет бесплатное приложение?", "Планируете добавить геймификацию?"]
new_questions = generator.generate_clarifying_questions(user_idea, existing_questions)
```

### Тестирование
Запустите тест для проверки работы системы:
```bash
python test_duplicate_prevention.py
```

## Настройки
- **Порог схожести**: 0.7 (70%) - можно изменить в методе `_is_similar_question()`
- **Количество учитываемых вопросов в промпте**: 10-15 последних вопросов
- **Целевое количество вопросов**: настраивается в `config.py`

## Преимущества
1. **Уникальность**: Исключение повторяющихся и похожих вопросов
2. **Качество**: Более разнообразные и содержательные вопросы
3. **Эффективность**: Избежание избыточных вопросов
4. **Персистентность**: Сохранение истории между итерациями
5. **Гибкость**: Настраиваемые пороги схожести

## Логирование
Система логирует:
- Найденные дубликаты с указанием схожести
- Исключенные вопросы
- Генерацию дополнительных вопросов при нехватке уникальных 